version: '3.2'

networks:
  pwg:
    external: false

volumes:
  sessions:
  networks:
  gitea:
    driver: local

services:
  controller:
    build:
      context: .
      dockerfile: ./docker/controller/Dockerfile
    ports:
      - "8081:8080"
    networks:
      - pwg
    volumes:
      - .:/start:ro
    command: ["-guideconfig=guides/gen_guide_structures.cue", "-prestepconfig=prestep_conf.cue", "-unsafe", "-origin=http://localhost:4000"]
    working_dir: "/start"
    environment:
      - GOPHERLIVE_ROOTCA

  haproxy:
    container_name: haproxy
    image: haproxy:2.2.3
    networks:
      - pwg
    ports:
        - "80:8080"
    volumes:
        - ./docker/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg

  nginx:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    environment:
      - PLAYWITHGODEV_CERT_FILE
      - PLAYWITHGODEV_KEY_FILE
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      pwg:
        aliases:
          - gopher.live
          - api.gopher.live

  gitea:
    image: gitea/gitea:1.12.4
    networks:
      - pwg
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - PLAYWITHGODEV_GITHUB_USER
      - PLAYWITHGODEV_GITHUB_PAT
    volumes:
      - ./docker/gitea/app.ini:/data/gitea/conf/app.ini:ro
      - gitea:/data

  cmd_gitea:
    build:
      context: .
      dockerfile: ./docker/cmd_gitea/Dockerfile
    networks:
      - pwg
    environment:
      - PLAYWITHGODEV_ROOT_USER
      - PLAYWITHGODEV_ROOT_PASSWORD
      - PLAYWITHGODEV_GITHUB_USER
      - PLAYWITHGODEV_GITHUB_PAT
      - GOPHERLIVE_ROOTCA
    command: ["/runbin/gitea", "serve"]

  pwd:
    build:
      context: .
      dockerfile: ./docker/pwd/Dockerfile
    networks:
      - pwg
    environment:
      - PWD_UNSAFE=true
    command: ["-save", "/pwd/sessions", "-name", "l2"]
    volumes:
      - sessions:/pwd
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /start
    container_name: pwd

  l2:
    build:
      context: .
      dockerfile: ./docker/l2/Dockerfile
    networks:
      - pwg
    command: ["-ssh_key_path", "/etc/ssh/ssh_host_rsa_key", "-save", "/pwd/networks", "-name", "l2"]
    volumes:
      - networks:/pwd
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /start
    container_name: l2

  site:
    build:
      context: .
      dockerfile: ./docker/site/Dockerfile
    volumes:
      - ./:/srv/jekyll
    ports:
      - 4000:4000
    command: ["jekyll", "serve"]

